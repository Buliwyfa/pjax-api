---
layout: bootstrap
title: Client-side Load Balancer
type: page
nav: nav
class: style-info
---

# Client-side Load Balancer
ルーターやロードバランサ不要のロードバランス機能をクライアントサイドで実現します。

主要ブラウザに対応しており回線帯域を150-2000%程度(100Mbps回線のサーバー群であれば150Mbps-2.0Gbps相当)に増設・分散する効果を見込めます。

セッションも複数のサーバーに分散できます。

回線帯域やセッション数といった高額で分散しにくいリソースをサーバーの追加のみで安価にスケールアウトし、ロードバランサなどの高価なネットワーク機器と高額な大容量回線のコストを削減できます。

アドレスバーのURLはもちろんすべてのサーバーで共通です。

※ 帯域計算は大手ニュースサイトのビジターのブラウザ比率に基づく(95%がバランス可能なブラウザ)。

<a href="{{ site.basepath }}demo/balance/" target="_blank" class="btn btn-primary" role="button">demo</a>

## 概要

* ロードバランス機能をクライアントサイドで実装(CsLB)
* サーバーサイドロードバランサとDNSラウンドロビンの併用を推奨(SsLB)
* サーバーの設定不要
* レスポンスの加工不要
* 回線帯域を超えるトラフィックを処理可能
* セッションを分散可能
* 回遊率の高いサイトで効果的
* 被リンクなどによる回遊でないアクセスには無効
* サーバーの応答性能に応じて負荷分散を最適化
* IndexedDBによりサーバー情報を保持
* CPU、メモリなどネットワーク以外のリソースのスケーリングには通常のロードバランサの使用を推奨

## ブラウザ対応
クロスドメインAjaxを使用できる必要があります。IndexedDBを使用できないブラウザではCookieを代わりに使用しますがサーバー情報を十分に保持できないため分散性能が劣化します。

|ブラウザ|クロスドメイン|リダイレクト|IndexedDB|Cookie|
|:---|:--:|:--:|:--:|:--:|
|Chrome|O|O|O|O|
|Firefox|O|O|O|O|
|Safari|O|O|O|O|
|IE10+|O|X|O|O|
|Android|O|X|4.4|O|
|iOS|O|X|8|O|

## クライアント実装
クライアントでサーバーリストを設定することでCsLBを適用します。サーバーを設定せずともCsLBを利用できますが、クライアントではDNSに登録しているような安定的なサーバーのみ設定し、動的なサーバーはサーバーからのレスポンスヘッダにより設定する使用方法を推奨します。

<pre class="sh brush: js;">
$.pjax({
  balance: {
    active: true,
    bounds: /^\d+\.site\.com$|cdn\.sites\.net:8080|^$/,
    client: {
      hosts: ['', '0.site.com', '1.site.com', 'cdn.sites.net:8080']
    }
  }
});
</pre>

## サーバー実装
サーバーからのレスポンスヘッダを通してバランス先のサーバーを設定します。すべてのサーバーを知らなくとも各サーバーから送られる情報を蓄積して自動的にサーバーリストを構築します。サーバーリストはIndexedDBの定期的な初期化により一定期間でリセットされます。

### 構成
本格的な構成では以下のようになるでしょう。負荷分散を行う場合、一般的に100.0.0.1xの箇所にルーター、スイッチ、ロードバランサ(SsLB)を設置しますが、ドメインに設定されたIP(サーバー)のごとの回線帯域が不足した場合、ロードバランサをDSRで動かしても前段にあるルーターやスイッチ自体の帯域と転送量(大抵サーバーと同じ帯域しかない)の制限は超えられないためトラフィックの分散としては意味がなく、帯域は100MBのままで結局回線帯域を増やす契約が必要となります。対してCsLBであればこうした中継点を経由せずサーバーにアクセスできるため通信機器と回線帯域の費用が発生しません。帯域はサーバーの数だけ増え、下図の100.0.0.1xではSsLBであれば100Mbpsしか使えないに対し、CsLBは300Mbpsが使用できます。また、DNSラウンドロビンによる負荷分散は偏りが生じる可能性があり、SsLBはこの影響を受けるところCsLBは影響を受けずレスポンスに応じて負荷を分散します。

負荷分散は正規サーバからすべてのAjaxサーバへ行われます。応答速度等サーバー性能に応じた負荷分散ができない都合上、セッション分散効果を優先してAjaxサーバからの負荷分散は行いません。

障害発生時のサーバーの切り替えは非正規サーバはCsLBが、正規サーバはDNSラウンドロビンが行います。

```
     BROWSER
        |
   _____|_____
  |           |
  |   Cs LB   |
  |___________|                   Balancing by CsLB
        |_______________________________________________________________________... 120.0.0.1x
        |                      |                      |                      |
   _____|_____                 |                      |                      |
  |           |                |                      |                      |
  |    DNS    |                |                      |                      |
  |round robin| ====================== INTERNET =============================================
  |___________|                |                      |                      |
        |                      = Balancing by DNS RR  =                      |
        |____________________________________________________________________|__... 120.0.0.1x
        |                                                                    |
        |                      =                      =                      |
    100.0.0.1x                 |                      |                  110.0.0.1x
   (100.0.0.10)                |                      |                      |
     100Mbps                   |                      |                      |
  .............                |                      |                      |
  :  Router?  : Standard       |                      |                      |
  :  Switch?  : load balance   |                      |                      |
  :   SsLB?   : point          |                      |                      |
  :...........:                |  Balancing by SsLB   |                      |
        |......................|......................|                      |
        |                      |                      |                      |
        |                      |                      |                      |
    100.0.0.11             100.0.0.12             100.0.0.13             110.0.0.11
   192.168.0.11           192.168.0.12           192.168.0.13           192.168.0.11
     100Mbps                100Mbps                100Mbps                100Mbps
   ___________            ___________            ___________            ___________
  |           | software |           | software |           | software |           | software
  |   [L B]   | balance  |           | balance  |           | balance  |   [L B]   | balance  
  |   [WEB]   |__________|   [WEB]   |__________|   [WEB]   |__________|   [WEB]   |__...
  |           |          |           |          |           |          |           |
  |___________|          |___________|          |___________|          |___________|
     site.com                  -                      -                   site.com
        |                      |                      |                      |
        |                      |                      |                      |
------------------------------------- APP Server --------------------------------------------
```

※ サーバーサイドロードバランサ、ソフトウェアロードバランサ、クライアントサイドロードバランサの違いに注意

### 処理の流れ

```
        ------------>  INTERNET(BROWSER)  <------------
        |                      A                      |
        |                      |                      |
        |                      |                      |
        V                      V                      V
       Ajax                 Regular                  Ajax
   ___________            ___________            ___________
  |           |          |           |          |           |
  |           | redirect |   [L B]   |  balance |           |
  |   [WEB]   |   <--    |   [WEB]   |    -->   |   [WEB]   |
  |   [APP]   |          |   [APP]   |    <--   |   [APP]   |
  |___________|          |___________|          |___________|
        -                  site.com                   -

        A                      A                      A
        |                      |                      |
        |                      V                      |
        |                 ___________                 |
        |                |           |                |
        ---------------> |   [D B]   | <---------------
                         |           |
                         |___________|
```

1 . [Client] URLに基づきDNSに登録された正規サーバへAjaxリクエスト

2A. [RServer] リダイレクト可能なブラウザであればLBサーバまたはAjaxサーバへリダイレクト(ブラウザはAjaxのリダイレクトを認識できない)

2B. [RServer] リダイレクト不能なブラウザであれば自身または他のサーバーへバランスする

3 . [AjaxServer] `Access-Control-Allow-Origin`ヘッダと`X-Ajax-Host`ヘッダを追加する

4A. [AjaxServer] 正規サーバへ戻らずAjaxサーバから直接ブラウザへレスポンスを返す

4B: [AjaxServer] 往路でLBサーバを経由している場合は復路もLBサーバを経由してレスポンスを返す

5 . [Client] Ajaxレスポン���によりページ遷移

6 . [Client] `X-Ajax-Host`ヘッダのサーバーをバランス先としてクライアントで登録

7A. [Client] 次回以降サイト内ページ遷移は登録されたサーバーのうちもっとも高速なものへ直接リクエストする

7B. [Client] ブラウザキャッシュの有効期限内のリクエストは前回と同じサーバーへリクエストする

※ 正規サーバはすべての非正規サーバへバランスしバランス先をCsLBに通知する  
※ 正規サーバからのリダイレクトの分散はリクエストヘッダによりリダイレクト先を変える方法が考えられる  
※ 正規サーバにLB機能を持たせた場合復路に正規サーバの回線を使用するため回線負荷がやや増える

### サーバー設定
サーバーでAjaxリクエストを振り分ける必要があります。振り分け先のサーバーは個別のグローバルIPと回線を持つものを用意する必要があります。通信の設定と流れは以下の通りです。

1. `X-Requested-With: XMLHttpRequest`ヘッダによりAjaxリクエストを識別
2. Cookieの`balance=1`フラグによりバランスするリクエストを識別
3. バランスするAjaxリクエストをソフトウェアロードバランサを入れたサーバーへ302リダイレクト
4. ロードバランサで自身のリバースプロキシまたは他のAjaxサーバへバランス
5. レスポンスヘッダに`Access-Control-Allow-Origin: <site-domain>`を追加
6. レスポンスヘッダに`X-Ajax-Host: <ajax-host>`を追加

### クライアント設定
ブラウザによってはクロスドメインAjaxにリクエストヘッダを追加できないことに注意してください。

[API: balance]({{ site.basepath }}api/core/setting/balance/)

<pre class="sh brush: js;">
$.pjax({
  balance: {
    active: true,
    bounds: /^\d+\.site\.com$|cdn\.sites\.net:8080|^$/,
    server: {
      //header: 'X-Ajax-Host'
    }
  }
});
</pre>

## プリロード対応

<pre class="sh brush: js;">
$.preload({
  ...
  balance: {
    host: $.pjax.host
  }
});
</pre>

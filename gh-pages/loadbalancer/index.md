---
layout: bootstrap
title: Client-side Load Balancer
type: page
nav: nav
class: style-info
---

# Client-side Load Balancer
ルーターやロードバランサ不要のロードバランス機能をクライアントサイドで実現します。

主要ブラウザに対応しており回線帯域を150-2000%程度(100Mbps回線のサーバー群であれば150Mbps-2.0Gbps相当)に増設・分散する効果を見込めます。

回線帯域やセッション数といった高額で分散しにくいリソースをサーバーの追加のみで安価にスケールアウトし、ロードバランサなどの高価なネットワーク機器と高額な大容量回線のコストを削減できます。

アドレスバーのURLはもちろんすべてのサーバーで共通です。

**実験的な機能であり動作検証中です。不具合やご意見等ありましたらお寄せください。**

※ 帯域計算は大手ニュースサイトのビジターのブラウザ比率に基づいたもの(95%がバランス可能なブラウザ)

## 概要

* ロードバランス機能をクライアントサイドで実装(CsLB)
* サーバーサイドロードバランサとDNSラウンドロビンの併用を推奨(SsLB)
* クッキーとIndexedDBの許可が必要
* サーバーの設定が必要
* レスポンスの加工は不要
* 回線帯域を超えるトラフィックを処理可能
* 回遊率の高いサイトで効果的
* 被リンクなどによる回遊でないアクセスには無効
* IE, Chrome, Firefox, Safariのデスクトップ版をバランス可能
* モバイルとタブレットも機能と性能が制限されるがバランス可能
* CPU、メモリなどネットワーク以外のリソースのみのスケーリングには通常のロードバランサを使用すべき

## 構成
本格的な構成では以下のようになるでしょう。負荷分散を行う場合、一般的に10.0.0.1xの箇所にルーター、スイッチ、ロードバランサ(SsLB)を設置しますが、ドメインに設定されたIP(サーバー)のごとの回線帯域が不足した場合、ロードバランサをDSRで動かしても前段にあるルーターやスイッチ自体の帯域と転送量(大抵サーバーと同じ帯域しかない)の制限は超えられないためトラフィックの分散としては意味がなく、帯域は100MBのままで結局回線帯域を増やす契約が必要となります。対してCsLBであればこうした中継点を経由せずサーバーにアクセスできるため通信機器と回線帯域の費用が発生しません。帯域はサーバーの数だけ増え、下図の10.0.0.1xではSsLBであれば100Mbpsしか使えないに対し、CsLBは300Mbpsが使用できます。また、DNSラウンドロビンによる負荷分散は偏りが生じる可能性があり、SsLBはこの影響を受けるところCsLBは影響を受けずレスポンスに応じて負荷を分散します。障害発生時のサーバーの切り替えは非正規サーバはCsLBが、正規サーバはDNSラウンドロビンが行います。

```
     BROWSER
        |
   _____|_____
  |           |
  |   Cs LB   |
  |___________|                   Balancing by CsLB
        |_______________________________________________________________________... 30.0.0.1x
        |                      |                      |                      |
   _____|_____                 |                      |                      |
  |           |                |                      |                      |
  |    DNS    |                |                      |                      |
  |round robin| ====================== INTERNET =============================================
  |___________|                |                      |                      |
        |                      = Balancing by DNS RR  =                      |
        |____________________________________________________________________|__... 30.0.0.1x
        |                                                                    |
        |                      =                      =                      |
    10.0.0.1x                  |                      |                  20.0.0.1x
   (10.0.0.10)                 |                      |                      |
     100Mbps                   |                      |                      |
  .............                |                      |                      |
  :  Router?  : Standard       |                      |                      |
  :  Switch?  : load balance   |                      |                      |
  :   SsLB?   : point          |                      |                      |
  :...........:                |  Balancing by SsLB   |                      |
        |......................|......................|                      |
        |                      |                      |                      |
        |                      |                      |                      |
    10.0.0.11              10.0.0.12              10.0.0.13              20.0.0.11
   192.168.0.11           192.168.0.12           192.168.0.13           192.168.0.11
     100Mbps                100Mbps                100Mbps                100Mbps
   ___________            ___________            ___________            ___________
  |           | software |           | software |           | software |           | software 
  |   [L B]   | balance  |   [L B]   | balance  |   [L B]   | balance  |   [L B]   | balance  
  |   [WEB]   |   -->    |   [WEB]   |   -->    |   [WEB]   |   -->    |   [WEB]   |   -->    
  |           |   <--    |           |   <--    |           |   <--    |           |   <--    
  |___________|          |___________|          |___________|          |___________|
     site.com                  -                      -                   site.com
        |                      |                      |                      |
        |                      |                      |                      |
------------------------------------- APP Server --------------------------------------------
```

※ サーバーサイドロードバランサ、ソフトウェアロードバランサ、クライアントサイドロードバランサの違いに注意

## 処理の流れ

```
 INTERNET(BROWSER)  <===================================
       | A                    | |                    | |
       | |Standard            | | Ajax               | | Ajax
       | |Ajax                | |                    | |
       V |                    | V                    | V
     Regular              LB and Ajax               Ajax
   ___________            ___________            ___________
  |           |          |           |          |           |
  |           | redirect |   [L B]   |  balance |           |
  |   [WEB]   |   -->    |   [WEB]   |    -->   |   [WEB]   |
  |   [APP]   |          |   [APP]   |    <--   |   [APP]   |
  |___________|          |___________|          |___________|
     site.com           mirror.site.com          1.othor.net

        A                      A                      A
        |                      |                      |
        |                      V                      |
        |                 ___________                 |
        |                |           |                |
        ---------------> |   [D B]   | <---------------
                         |           |
                         |___________|
```

1 . [Client] URLに基づきDNSに登録された正規サーバへAjaxリクエスト

2A. [RServer] リダイレクト可能なブラウザであればLBサーバまたはAjaxサーバへリダイレクト(ブラウザはAjaxのリダイレクトを認識できない)

2B. [RServer] リダイレクト不能なブラウザであれば自身または他のLBサーバへバランスする

3 . [LBServer] Ajaxサーバへバランスする

4 . [AjaxServer] `Access-Control-Allow-Origin`ヘッダと`X-Ajax-Host`ヘッダを追加する

5A. [AjaxServer] 正規サーバへ戻らずAjaxサーバから直接ブラウザへレスポンスを返す

5B: [AjaxServer] 往路でLBサーバを経由している場合は復路もLBサーバを経由してレスポンスを返す

6 . [Client] Ajaxレスポンスによりページ遷移

7 . [Client] `X-Ajax-Host`ヘッダのサーバーをバランス先としてクライアントで登録

8A. [Client] 次回以降サイト内ページ遷移は登録されたサーバーのうちもっとも高速なものへ直接リクエストする

8B. [Client] ブラウザキャッシュの有効期限内のリクエストは前回と同じサーバーへリクエストする

※ すべてのAjaxサーバにLB機能を持たせてAjaxサーバ同士で負荷を分散できるようにすることが望ましい。  
※ LBサーバは所属のAjaxサーバとすべての正規サーバへバランスする  
※ 正規サーバからのリダイレクトの分散はリクエストヘッダによりリダイレクト先を変える方法が考えられる  
※ 正規サーバにLB機能を持たせた場合復路に正規サーバの回線を使用するため回線負荷がやや増える

## ブラウザ対応
少なくともクロスドメインAjaxとIndexedDBまたはCookieを使用できる必要があります。IndexedDBが使用できない場合でもCookieによりバランスしますがサーバー選択の最適化機能を使用できず性能がかなり劣化します。現在モバイル端末の多くはCookieによる最低限の対応となりますが、端末の更新により今後IndexedDBが使用できるようになっていくでしょう。

|ブラウザ|クロスドメイン|リダイレクト|IndexedDB|Cookie|
|:---|:--:|:--:|:--:|:--:|
|Chrome|O|O|O|O|
|Firefox|O|O|O|O|
|Safari|O|O|O|O|
|IE10+|O|X|O|O|
|Tablet|O|?|?|O|
|Android|O|X|4.4|O|
|iOS|O|X|8|O|

## サーバー設定
サーバーでAjaxリクエストを振り分ける必要があります。振り分け先のサーバーは個別のグローバルIPと回線を持つものを用意する必要があります。通信の設定と流れは以下の通りです。

1. `X-Requested-With: XMLHttpRequest`ヘッダによりAjaxリクエストを識別
2. Cookieの`ajax_balance=1`フラグによりバランスするリクエストを識別
3. バランスするAjaxリクエストをソフトウェアロードバランサを入れたサーバーへ302リダイレクト
4. ロードバランサで自身のリバースプロキシまたは他のAjaxサーバへバランス
5. レスポンスヘッダに`Access-Control-Allow-Origin: <site-domain>`を追加
6. レスポンスヘッダに`X-Ajax-Host: <ajax-host>`を追加

## クライアント設定
pjaxの設定によりクライアント側でAjaxリクエストを振り分けることができます。サーバーでのみバランスさせる場合は設定は不要です。リクエスト先はその時点でもっとも高速なサーバーが自動的に選択されます。ダウンなどにより通信エラーが発生したサーバーは一定時間リクエスト先から除外されます。リクエストヘッダを追加できないことに注意してください。

[API: balance](api/core/setting/balance/)

<pre class="sh brush: js;">
$.pjax({
  balance: {
    self: true
  }
});
</pre>

<pre class="sh brush: js;">
$.preload({
  balance: {
    host: $.pjax.host
  }
});
</pre>

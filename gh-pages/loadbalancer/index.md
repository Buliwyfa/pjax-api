---
layout: bootstrap
title: Client-side Load Balancer
type: page
nav: nav
class: style-info
---

# Client-side Load Balancer
ルーターやロードバランサ不要のロードバランス機能をクライアントサイドで実現します。

主要ブラウザに対応しており回線帯域を150-2000%程度(100Mbps回線のサーバー群であれば150Mbps-2.0Gbps相当)に増設・分散する効果を見込めます。

回線帯域やセッション数といった高額で分散しにくいリソースをサーバーの追加のみで安価にスケールアウトし、ロードバランサなどの高価なネットワーク機器と高額な大容量回線のコストも削減できます。

アドレスバーのURLはもちろんすべてのサーバーで共通です。

**実験的な機能であり動作検証中です。不具合やご意見等ありましたらお寄せください。**

※ 帯域計算は大手ニュースサイトのビジターのブラウザ比率に基づいたもの(95%がバランス可能なブラウザ)

## 概要

* ロードバランス機能をクライアントサイドで実装(CsLB)
* サーバーサイドロードバランサの併用を推奨(SsLB)
* クッキーとIndexedDBの許可が必要
* サーバーの設定が必要
* レスポンスの加工は不要
* 回線帯域を超えるトラフィックを処理可能
* 回遊率の高いサイトで効果的
* 被リンクなどによる回遊でないアクセスには無効
* IE, Chrome, Firefox, Safariのデスクトップ版をバランス可能
* モバイルとタブレットも機能と性能が制限されるがバランス可能
* CPU、メモリなどネットワーク以外のリソースのみのスケーリングには通常のロードバランサを使用すべき

## 処理の流れ

```
 INTERNET(BROWSER)  <===================================
       | A                    | |                    | |
       | |Standard            | | Ajax               | | Ajax
       | |Ajax                | |                    | |
       V |                    | V                    | V
     Regular              LB and Ajax               Ajax
   ___________            ___________            ___________
  |           |          |           |          |           |
  |           | redirect |   [L B]   |  balance |           |
  |   [WEB]   |   -->    |   [WEB]   |    -->   |   [WEB]   |
  |   [APP]   |          |   [APP]   |    <--   |   [APP]   |
  |___________|          |___________|          |___________|
     site.com              1.temp.net             2.temp.net

        A                      A                      A
        |                      |                      |
        |                      V                      |
        |                 ___________                 |
        |                |           |                |
        ---------------> |   [D B]   | <---------------
                         |           |
                         |___________|
```

1 . [Client] URLに基づきDNSに登録された正規サーバへAjaxリクエスト

2A. [Server] リダイレクト可能なブラウザであればLBサーバまたはAjaxサーバへリダイレクト(ブラウザはAjaxのリダイレクトを認識できない)

2B. [Server] リダイレクト不能なブラウザであれば自身がAjaxサーバとなるが次回以降別のLBサーバまたはAjaxサーバへバランスされるよう`X-Ajax-Host`ヘッダにそのサーバーを設定する

3A. [LBServer] 自身がAjaxサーバとなる(他のバランス先がなければLBは不要)

3B. [LBServer] または他のAjaxサーバにバランスする

4 . [AjaxServer] `Access-Control-Allow-Origin`ヘッダと`X-Ajax-Host`ヘッダを追加する

5A. [AjaxServer] 正規サーバへ戻らずAjaxサーバから直接ブラウザへレスポンスを返す

5B: [AjaxServer] 往路でLBサーバを経由している場合は復路もLBサーバを経由してレスポンスを返す

6 . [Client] Ajaxレスポンスによりページ遷移

7 . [Client] `X-Ajax-Host`ヘッダのサーバーをバランス先としてクライアントで登録

8A. [Client] 次回以降サイト内ページ遷移は登録されたサーバーのうちもっとも高速なものへ直接リクエストする

8B. [Client] ブラウザキャッシュの有効期限内のリクエストは前回と同じサーバーへリクエストする

※ すべてのAjaxサーバにLB機能を持たせてAjaxサーバ同士で負荷を分散できるようにすることが望ましい。  
※ 正規サーバからのリダイレクトの分散はリクエストヘッダによりリダイレクト先を変える方法が考えられる  
※ 正規サーバにLB機能を持たせる方法もあるが復路に正規サーバの回線を使用するため回線負荷がやや増える

## ブラウザ対応
少なくともクロスドメインAjaxとIndexedDBまたはCookieを使用できる必要があります。IndexedDBが使用できない場合でもCookieによりバランスしますがサーバー選択の最適化機能を使用できず性能がかなり劣化します。

|ブラウザ|クロスドメイン|リダイレクト|IndexedDB|Cookie|
|:---|:--:|:--:|:--:|:--:|
|Chrome|O|O|O|O|
|Firefox|O|O|O|O|
|Safari|O|O|O|O|
|IE10+|O|X|O|O|
|Tablet|O|?|?|O|
|Android|O|X|X|O|
|iPhone|O|X|X|O|

## サーバー設定
サーバーでAjaxリクエストを振り分ける必要があります。振り分け先のサーバーは個別のグローバルIPと回線を持つものを用意する必要があります。通信の設定と流れは以下の通りです。

1. `X-Requested-With: XMLHttpRequest`ヘッダによりAjaxリクエストを識別
2. Cookieの`balance=1`フラグによりバランスするリクエストを識別
3. バランスするAjaxリクエストをソフトウェアロードバランサを入れたサーバーへ302リダイレクト
4. ロードバランサで自身のリバースプロキシまたは他のAjaxサーバへバランス
5. レスポンスヘッダに`Access-Control-Allow-Origin: <site-domain>`を追加
6. レスポンスヘッダに`X-Ajax-Host: <ajax-host>`を追加

## クライアント設定
pjaxの設定によりクライアント側でAjaxリクエストを振り分けることができます。サーバーでのみバランスさせる場合は設定は不要です。リクエスト先はその時点でもっとも高速なサーバーが自動的に選択されます。ダウンなどにより通信エラーが発生したサーバーは一定時間リクエスト先から除外されます。リクエストヘッダを追加できないことに注意してください。

[API: balance](api/core/setting/balance/)

<pre class="sh brush: js;">
$.pjax({
  balance: {
    self: true
  }
});
</pre>

<pre class="sh brush: js;">
$.preload({
  balance: {
    host: $.pjax.host
  }
});
</pre>
